! ------------------- VRF -------------------------
! Control Plane VRF
vrf definition MLAG_CONTROL_PLANE
    description MLAG_CONTROL_PLANE
    rd {{ eos_mlag_setup.site }}:{{ eos_mlag_setup.domain }}

! ------------------- LINKAGG ----------------------
! Create Port-channel
interface Port-Channel{{ eos_mlag_setup.linkagg }}
    exit

! Peering Port-Channel 
{% for link in eos_mlag_setup.interlinks %}
interface Ethernet {{ link }}
    channel-group {{ eos_mlag_setup.linkagg }} mode active
    exit
{% endfor %}

interface Port-Channel{{ eos_mlag_setup.linkagg }}
    switchport
    switchport mode trunk
    switchport trunk group mlagpeer
    switchport trunk allowed vlans {{ eos_mlag_setup.vlans | join(',') }}
    no shutdown
    exit

! -------------------- VLAN ----------------------
! Peering VLAN
vlan {{ eos_mlag_setup.vlan }}
    trunk group mlagpeer
    exit

no spanning-tree vlan {{ eos_mlag_setup.vlan }}

! VLANs member of MLAG domain
{%  for eos_mlag_vlan in eos_mlag_setup.vlans %}
{%      if eos_mlag_vlan != "all" %}
vlan {{ eos_mlag_vlan }} 
    exit
{%      endif %}
{% endfor %}

interface Vlan{{ eos_mlag.vlan }}
    ip address 169.254.{{ eos_mlag_setup.domain }}.{{ eos_mlag_setup.site }}{{ eos_mlag_setup.device }}/24
    no autostate
    exit

! -------------------- MLAG ----------------------
! MLAG Configuration
mlag configuration
    local-interface Vlan{{ eos_mlag_setup.vlan }}
    peer-address 169.254.{{ eos_mlag_setup.site }}.{{ hostvars[eos_mlag_setup.peer].eos_mlag_setup.device }}
    peer-link port-channel {{ eos_mlag_setup.linkagg }}
    domain-id {{ eos_mlag_setup.domain }}
    heartbeat-interval {{ eos_mlag_setup.heartbeat }}
    reload-delay {{ eos_mlag_setup.reload_delay }}
    ip virtual-router mac-address mlag-peer
    platform send multicast replication default ingress
    exit
